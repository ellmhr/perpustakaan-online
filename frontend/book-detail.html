<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Detail Buku - Bookridge</title>
  <link rel="stylesheet" href="css/style.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
  
  <!-- Navbar -->
  <nav class="navbar">
    <div class="container navbar-container">
      <a href="dashboard.html" class="navbar-brand">
        <i class="fas fa-book-open" style="font-size: 1.5rem; color: var(--primary);"></i>
        <h2>Bookridge</h2>
      </a>
      <ul class="navbar-menu">
        <li><a href="dashboard.html">Dashboard</a></li>
        <li><a href="search.html" class="active">Cari Buku</a></li>
        <li><a href="my-loans.html">Peminjaman</a></li>
        <li><a href="history.html">Riwayat</a></li>
        <li><a href="profile.html">Profil</a></li>
        <li><a href="#" onclick="logout()" style="color: var(--danger);">Logout</a></li>
      </ul>
    </div>
  </nav>

  <!-- Main Content -->
  <div class="container" style="padding-top: 2rem; padding-bottom: 2rem;">
    
    <!-- Back Button -->
    <button onclick="history.back()" class="btn btn-secondary" style="margin-bottom: 1.5rem;">
      <i class="fas fa-arrow-left"></i> Kembali
    </button>

    <!-- Book Detail Container -->
    <div id="bookDetailContainer">
      <!-- Loading -->
      <div class="loader">
        <div class="spinner"></div>
      </div>
    </div>

  </div>

  <!-- Bottom Navigation -->
  <div class="bottom-nav">
    <div class="bottom-nav-container">
      <a href="dashboard.html" class="bottom-nav-item">
        <i class="fas fa-home"></i>
        <span>Beranda</span>
      </a>
      <a href="search.html" class="bottom-nav-item active">
        <i class="fas fa-search"></i>
        <span>Cari</span>
      </a>
      <a href="my-loans.html" class="bottom-nav-item">
        <i class="fas fa-book"></i>
        <span>Pinjaman</span>
      </a>
      <a href="profile.html" class="bottom-nav-item">
        <i class="fas fa-user"></i>
        <span>Akun</span>
      </a>
    </div>
  </div>

  <script src="js/config.js"></script>
  <script>
    // Check authentication
    if (!isLoggedIn()) {
      window.location.href = 'login.html';
    }

    // Get book ID from URL
    const urlParams = new URLSearchParams(window.location.search);
    const bookId = urlParams.get('id');

    if (!bookId) {
      window.location.href = 'search.html';
    }

    // Load book detail
    async function loadBookDetail() {
      const container = document.getElementById('bookDetailContainer');
      
      try {
        const response = await fetch(BOOK_ENDPOINTS.DETAIL(bookId), {
          headers: getAuthHeaders()
        });
        
        const data = await response.json();
        
        if (response.ok && data.success) {
          const book = data.data;
          displayBookDetail(book);
        } else {
          container.innerHTML = `
            <div class="alert alert-error">
              Buku tidak ditemukan
            </div>
          `;
        }
      } catch (error) {
        console.error('Error loading book:', error);
        container.innerHTML = `
          <div class="alert alert-error">
            Tidak dapat terhubung ke server
          </div>
        `;
      }
    }

    // Display book detail
    function displayBookDetail(book) {
      const container = document.getElementById('bookDetailContainer');
      
      container.innerHTML = `
        <div class="card" style="max-width: 800px; margin: 0 auto;">
          <div style="display: grid; grid-template-columns: 1fr 2fr; gap: 2rem;">
            
            <!-- Book Cover -->
            <div>
              <div style="width: 100%; aspect-ratio: 2/3; background: linear-gradient(135deg, var(--primary-light), var(--primary)); border-radius: var(--radius-md); display: flex; align-items: center; justify-content: center; color: white; font-size: 4rem; overflow: hidden;">
                ${book.cover_image ? 
                  `<img src="${getBookCoverUrl(book.cover_image)}" alt="${book.judul}" style="width: 100%; height: 100%; object-fit: cover;" onerror="this.style.display='none'; this.parentElement.innerHTML='<i class=\\'fas fa-book\\'></i>'">` 
                  : 
                  '<i class="fas fa-book"></i>'
                }
              </div>
            </div>

            <!-- Book Info -->
            <div>
              <h1 style="color: var(--text-dark); margin-bottom: 0.5rem;">${book.judul}</h1>
              
              <div style="margin-bottom: 1.5rem;">
                <p style="color: var(--text-medium); margin-bottom: 0.5rem;">
                  <i class="fas fa-user"></i> <strong>Penulis:</strong> ${book.penulis}
                </p>
                <p style="color: var(--text-medium); margin-bottom: 0.5rem;">
                  <i class="fas fa-building"></i> <strong>Penerbit:</strong> ${book.penerbit || '-'}
                </p>
                <p style="color: var(--text-medium); margin-bottom: 0.5rem;">
                  <i class="fas fa-calendar"></i> <strong>Tahun:</strong> ${book.tahun_terbit || '-'}
                </p>
                <p style="color: var(--text-medium); margin-bottom: 0.5rem;">
                  <i class="fas fa-boxes"></i> <strong>Stok:</strong> 
                  <span class="badge ${book.stok > 0 ? 'badge-success' : 'badge-danger'}">
                    ${book.stok > 0 ? `${book.stok} tersedia` : 'Habis'}
                  </span>
                </p>
              </div>

              <!-- Alert -->
              <div id="loanAlert" class="hidden"></div>

              <!-- Loan Info -->
              <div class="card" style="background: var(--bg-light); padding: 1rem; margin-bottom: 1rem;">
                <h3 style="color: var(--text-dark); margin-bottom: 0.5rem; font-size: 1rem;">
                  <i class="fas fa-info-circle"></i> Informasi Peminjaman
                </h3>
                <ul style="list-style: none; padding-left: 0; color: var(--text-medium); font-size: 0.9rem;">
                  <li style="margin-bottom: 0.25rem;">• Masa peminjaman: <strong>7 hari</strong></li>
                  <li style="margin-bottom: 0.25rem;">• Denda keterlambatan: <strong>Rp1.000/hari</strong></li>
                  <li style="margin-bottom: 0.25rem;">• Buku diambil di perpustakaan</li>
                </ul>
              </div>

              <!-- Borrow Button -->
              ${book.stok > 0 ? `
                <button onclick="borrowBook(${book.id_buku})" class="btn btn-primary btn-full" id="borrowBtn">
                  <i class="fas fa-hand-holding-heart"></i> Pinjam Buku
                </button>
              ` : `
                <button class="btn btn-secondary btn-full" disabled>
                  <i class="fas fa-ban"></i> Stok Habis
                </button>
              `}
            </div>

          </div>
        </div>
      `;
    }

    // Borrow book
    async function borrowBook(id_buku) {
      const btn = document.getElementById('borrowBtn');
      const originalText = btn.innerHTML;
      const alertDiv = document.getElementById('loanAlert');
      
      // Disable button
      btn.disabled = true;
      btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Memproses...';
      
      try {
        const response = await fetch(LOAN_ENDPOINTS.CREATE, {
          method: 'POST',
          headers: getAuthHeaders(),
          body: JSON.stringify({ id_buku })
        });
        
        const data = await response.json();
        
        if (response.ok && data.success) {
          alertDiv.className = 'alert alert-success';
          alertDiv.innerHTML = `
            <i class="fas fa-check-circle"></i>
            ${data.message}
          `;
          alertDiv.classList.remove('hidden');
          
          // Redirect after 2 seconds
          setTimeout(() => {
            window.location.href = 'my-loans.html';
          }, 2000);
        } else {
          alertDiv.className = 'alert alert-error';
          alertDiv.innerHTML = `
            <i class="fas fa-exclamation-circle"></i>
            ${data.message || 'Peminjaman gagal'}
          `;
          alertDiv.classList.remove('hidden');
          
          btn.disabled = false;
          btn.innerHTML = originalText;
        }
      } catch (error) {
        console.error('Borrow error:', error);
        alertDiv.className = 'alert alert-error';
        alertDiv.innerHTML = `
          <i class="fas fa-exclamation-circle"></i>
          Tidak dapat terhubung ke server
        `;
        alertDiv.classList.remove('hidden');
        
        btn.disabled = false;
        btn.innerHTML = originalText;
      }
    }

    // Initialize
    loadBookDetail();
  </script>

</body>
</html>
